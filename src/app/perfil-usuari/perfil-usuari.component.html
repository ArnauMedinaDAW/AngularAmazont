<!-- <div class="contenedor-principal" [ngClass]="{'dark': oscuro()}"> -->
  <h1>Perfil de Usuario</h1>

  <!-- Información personal -->
  <section class="seccion">
    <h2>Información Personal</h2>
    <form [formGroup]="perfilForm" (ngSubmit)="guardarPerfil()">
      <div class="form-group">
        <label>Nick:
          <input formControlName="nick" />
          @if (perfilForm.get('nick')?.invalid && perfilForm.get('nick')?.touched) {
            <span class="error-message">Nick inválido</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Email:
          <input formControlName="email" type="email" />
          @if (perfilForm.get('email')?.invalid && perfilForm.get('email')?.touched) {
            <span class="error-message">Email inválido</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Dirección de envío:
          <input formControlName="direccion_envio" />
          @if (perfilForm.get('direccion_envio')?.invalid && perfilForm.get('direccion_envio')?.touched) {
            <span class="error-message">Dirección inválida</span>
          }
        </label>
      </div>

      <button type="submit" [disabled]="perfilForm.invalid">Guardar Perfil</button>
      @if (perfilGuardado) {
        <p class="mensaje-exito">Perfil guardado correctamente.</p>
      }
    </form>
  </section>

  <!-- Historial de pedidos -->
  <section class="seccion">
    <h2>Historial de Pedidos</h2>
    @if (pedidos.length === 0) {
      <p>No tienes pedidos realizados.</p>
    } @else {
      <div class="pedidos-container">
        @for (pedido of pedidos; track pedido.id) {
          <div class="pedido-card">
            <h3>{{ pedido.id }} - {{ pedido.estado }}</h3>
            <p>Fecha: {{ pedido.fecha | date }}</p>
            <p>Total: {{ pedido.total | currency:'EUR' }}</p>
            <details>
              <summary>Ver productos</summary>
              <ul>
                @for (prod of pedido.productos; track prod.nombre) {
                  <li>
                    {{ prod.nombre }} - {{ prod.cantidad }} x {{ prod.precio | currency:'EUR' }}
                  </li>
                }
              </ul>
            </details>
            <button (click)="verDetallePedido(pedido.id)">Ver Detalle</button>
          </div>
        }
      </div>
    }
  </section>

  <!-- Métodos de pago -->
  <section class="seccion">
    <h2>Métodos de Pago</h2>

    <!-- Replacing the debug info with a styled summary -->
    <div class="metodos-resumen">
      <p>Tienes <span class="metodos-count">{{ metodosPago.length }}</span> método(s) de pago guardado(s)</p>
    </div>

    <!-- Formulario para añadir método de pago -->
    <form [formGroup]="metodoPagoForm" (ngSubmit)="guardarMetodoPago()" class="metodo-pago-form">
      <h3>{{ editandoMetodoPago ? 'Editar' : 'Añadir' }} método de pago</h3>

      <div class="form-group">
        <label>Tipo:
          <select formControlName="tipo">
            <option value="Visa">Visa</option>
            <option value="MasterCard">MasterCard</option>
            <option value="PayPal">PayPal</option>
            <option value="American Express">American Express</option>
          </select>
          @if (metodoPagoForm.get('tipo')?.invalid && metodoPagoForm.get('tipo')?.touched) {
            <span class="error-message">Tipo requerido</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Nombre en la tarjeta:
          <input formControlName="nombre" />
          @if (metodoPagoForm.get('nombre')?.invalid && metodoPagoForm.get('nombre')?.touched) {
            <span class="error-message">Nombre requerido</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Número de tarjeta:
          <input formControlName="num_tarjeta" />
          @if (metodoPagoForm.get('num_tarjeta')?.invalid && metodoPagoForm.get('num_tarjeta')?.touched) {
            <span class="error-message">Número de tarjeta inválido</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Fecha de caducidad:
          <input formControlName="fecha_caducidad" placeholder="MM/YY" />
          @if (metodoPagoForm.get('fecha_caducidad')?.invalid && metodoPagoForm.get('fecha_caducidad')?.touched) {
            <span class="error-message">Fecha inválida</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Código de validación:
          <input formControlName="codigo_validacion" type="password" maxlength="3" />
          @if (metodoPagoForm.get('codigo_validacion')?.invalid && metodoPagoForm.get('codigo_validacion')?.touched) {
            <span class="error-message">Código inválido</span>
          }
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="metodoPagoForm.invalid">{{ editandoMetodoPago ? 'Actualizar' : 'Añadir' }}</button>
        @if (editandoMetodoPago) {
          <button type="button" (click)="cancelarEdicion()">Cancelar</button>
        }
      </div>

      @if (metodoPagoGuardado) {
        <p class="mensaje-exito">Método de pago guardado correctamente.</p>
      }
    </form>

    <!-- Lista de métodos de pago -->
    @if (metodosPago.length === 0) {
      <p>No tienes métodos de pago guardados.</p>
    } @else {
      <div class="metodos-pago-container">
        @for (metodo of metodosPago; track metodo.id_metodo) {
          <div class="metodo-pago-card">
            <h3>{{ metodo.tipo }}</h3>
            <p>{{ metodo.nombre }}</p>
            <p>**** **** **** {{ obtenerUltimosDigitos(metodo.num_tarjeta) }}</p>
            @if (metodo.fecha_caducidad) {
              <p>Expira: {{ metodo.fecha_caducidad }}</p>
            }
            @if (metodo.predeterminado) {
              <span class="badge-predeterminado">Predeterminado</span>
            }
            <div class="metodo-actions">
              @if (!metodo.predeterminado) {
                <button (click)="establecerPredeterminado(metodo.id_metodo)">Establecer como predeterminado</button>
              }
              <button (click)="editarMetodoPago(metodo)">Editar</button>
              <button class="btn-eliminar" (click)="eliminarMetodoPago(metodo.id_metodo)">Eliminar</button>
            </div>
          </div>
        }
      </div>
    }
  </section>

  <!-- Seguridad -->
  <section class="seccion">
    <h2>Seguridad de la Cuenta</h2>
    <form [formGroup]="securityForm" (ngSubmit)="cambiarPassword()">
      <div class="form-group">
        <label>Contraseña Actual:
          <input type="password" formControlName="passwordActual" />
          @if (securityForm.get('passwordActual')?.invalid && securityForm.get('passwordActual')?.touched) {
            <span class="error-message">Contraseña actual requerida</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Nueva Contraseña:
          <input type="password" formControlName="passwordNueva" />
          @if (securityForm.get('passwordNueva')?.invalid && securityForm.get('passwordNueva')?.touched) {
            <span class="error-message">La contraseña debe tener al menos 8 caracteres</span>
          }
        </label>
      </div>

      <div class="form-group">
        <label>Confirmar Nueva Contraseña:
          <input type="password" formControlName="passwordConfirmar" />
          @if ((securityForm.get('passwordConfirmar')?.invalid || securityForm.hasError('passwordMismatch')) && securityForm.get('passwordConfirmar')?.touched) {
            <span class="error-message">
              Las contraseñas no coinciden
            </span>
          }
        </label>
      </div>

      <button type="submit" [disabled]="securityForm.invalid">Cambiar Contraseña</button>
      @if (passwordChanged) {
        <p class="mensaje-exito">Contraseña actualizada con éxito.</p>
      }
    </form>
  </section>
<!-- </div> -->
