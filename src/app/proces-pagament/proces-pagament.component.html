<div [ngClass]="{'dark': oscuro}" class="payment-process-container py-4">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h3 class="mb-4"><i class="fas fa-credit-card me-2"></i>Proceso de Pago</h3>
        
        @if (pagamentExitos) {
          <div class="payment-success text-center py-5">
            <div class="success-animation mb-4">
              <div class="checkmark-circle">
                <div class="background"></div>
                <div class="checkmark draw"></div>
              </div>
            </div>
            <h2 class="mb-3">¡Pago realizado con éxito!</h2>
            <p class="mb-4">Gracias por tu compra. Recibirás un correo electrónico con los detalles de tu pedido.</p>
            <div class="spinner-border text-primary" role="status">
            </div>
            <p class="mt-2">Redirigiendo a la tienda...</p>
          </div>
        } @else {
          <div class="row">
            <div class="col-md-4 order-md-2 mb-4">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-3">Resumen del pedido</h5>
                  
                  @for (item of elementsCarret; track item.product.id) {
                    <div class="d-flex justify-content-between mb-2">
                      <span>{{ item.product.nombre }} x{{ item.cantidad }}</span>
                      <span>{{ (item.product.precio * item.cantidad) | currency:'EUR' }}</span>
                    </div>
                  }
                  
                  <hr>
                  
                  <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>{{ total | currency:'EUR' }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Gastos de envío:</span>
                    <span>{{ costEnviament | currency:'EUR' }}</span>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between mb-3 fw-bold">
                    <span>Total:</span>
                    <span>{{ (total + costEnviament) | currency:'EUR' }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Payment form -->
            <div class="col-md-8 order-md-1">
              @if (processantPagament) {
                <div class="text-center py-5">
                  <div class="spinner-border text-primary mb-3" role="status">
                  </div>
                  <h4>Procesando tu pago</h4>
                  <p>Por favor, espera un momento mientras procesamos tu pago...</p>
                </div>
              } @else {
                <form [formGroup]="formulariPagament" (ngSubmit)="enviarFormulari()">
                  <!-- Shipping address -->
                  <h5 class="mb-3">Dirección de envío</h5>
                  <div class="row g-3 mb-4">
                    <div class="col-12">
                      <label for="nomComplet" class="form-label">Nombre completo</label>
                      <input type="text" class="form-control" id="nomComplet" formControlName="nomComplet">
                      @if (formulariPagament.get('nomComplet')?.invalid && formulariPagament.get('nomComplet')?.touched) {
                        <div class="text-danger mt-1">Nombre completo es requerido</div>
                      }
                    </div>
                    
                    <div class="col-12">
                      <label for="adreca" class="form-label">Dirección</label>
                      <input type="text" class="form-control" id="adreca" formControlName="adreca" placeholder="Calle, número, piso...">
                      @if (formulariPagament.get('adreca')?.invalid && formulariPagament.get('adreca')?.touched) {
                        <div class="text-danger mt-1">Dirección es requerida</div>
                      }
                    </div>
                    
                    <div class="col-md-6">
                      <label for="ciutat" class="form-label">Ciudad</label>
                      <input type="text" class="form-control" id="ciutat" formControlName="ciutat">
                      @if (formulariPagament.get('ciutat')?.invalid && formulariPagament.get('ciutat')?.touched) {
                        <div class="text-danger mt-1">Ciudad es requerida</div>
                      }
                    </div>
                    
                    <div class="col-md-6">
                      <label for="codiPostal" class="form-label">Código postal</label>
                      <input type="text" class="form-control" id="codiPostal" formControlName="codiPostal">
                      @if (formulariPagament.get('codiPostal')?.invalid && formulariPagament.get('codiPostal')?.touched) {
                        <div class="text-danger mt-1">Código postal válido es requerido (5 dígitos)</div>
                      }
                    </div>
                    
                    <div class="col-12">
                      <label for="pais" class="form-label">País</label>
                      <input type="text" class="form-control" id="pais" formControlName="pais">
                      @if (formulariPagament.get('pais')?.invalid && formulariPagament.get('pais')?.touched) {
                        <div class="text-danger mt-1">País es requerido</div>
                      }
                    </div>
                  </div>
                  
                  <!-- Payment method -->
                  <h5 class="mb-3">Método de pago</h5>
                  <div class="mb-4">
                    <div class="form-check mb-2" *ngFor="let method of metodesPagament">
                      <input class="form-check-input" type="radio" [id]="method" formControlName="metodePagament" [value]="method">
                      <label class="form-check-label" [for]="method">
                        {{ method }}
                      </label>
                    </div>
                  </div>
                  
                  <!-- Credit card details -->
                  @if (mostrarFormulariTarjeta) {
                    <div class="credit-card-form mb-4">
                      <div class="row g-3">
                        <div class="col-12">
                          <label for="numeroTarjeta" class="form-label">Número de tarjeta</label>
                          <input type="text" class="form-control" id="numeroTarjeta" formControlName="numeroTarjeta" placeholder="1234 5678 9012 3456">
                          @if (formulariPagament.get('numeroTarjeta')?.invalid && formulariPagament.get('numeroTarjeta')?.touched) {
                            <div class="text-danger mt-1">Número de tarjeta válido es requerido (16 dígitos)</div>
                          }
                        </div>
                        
                        <div class="col-12">
                          <label for="nomTarjeta" class="form-label">Nombre en la tarjeta</label>
                          <input type="text" class="form-control" id="nomTarjeta" formControlName="nomTarjeta">
                          @if (formulariPagament.get('nomTarjeta')?.invalid && formulariPagament.get('nomTarjeta')?.touched) {
                            <div class="text-danger mt-1">Nombre en la tarjeta es requerido</div>
                          }
                        </div>
                        
                        <div class="col-md-6">
                          <label for="dataExpiracio" class="form-label">Fecha de expiración</label>
                          <input type="text" class="form-control" id="dataExpiracio" formControlName="dataExpiracio" placeholder="MM/AA">
                          @if (formulariPagament.get('dataExpiracio')?.invalid && formulariPagament.get('dataExpiracio')?.touched) {
                            <div class="text-danger mt-1">Fecha de expiración es requerida</div>
                          }
                        </div>
                        
                        <div class="col-md-6">
                          <label for="cvv" class="form-label">CVV</label>
                          <input type="text" class="form-control" id="cvv" formControlName="cvv" placeholder="123">
                          @if (formulariPagament.get('cvv')?.invalid && formulariPagament.get('cvv')?.touched) {
                            <div class="text-danger mt-1">CVV válido es requerido (3-4 dígitos)</div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                  
                  <!-- Terms and conditions -->
                  <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="acceptarTermes" formControlName="acceptarTermes">
                    <label class="form-check-label" for="acceptarTermes">
                      Acepto los términos y condiciones
                    </label>
                    @if (formulariPagament.get('acceptarTermes')?.invalid && formulariPagament.get('acceptarTermes')?.touched) {
                      <div class="text-danger mt-1">Debes aceptar los términos y condiciones</div>
                    }
                  </div>
                  
                  <!-- Submit buttons -->
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" (click)="cancelarPagament()">
                      <i class="fas fa-arrow-left me-2"></i>Volver al carrito
                    </button>
                    <button type="submit" class="btn btn-success" [disabled]="formulariPagament.invalid">
                      <i class="fas fa-check me-2"></i>Confirmar compra
                    </button>
                  </div>
                </form>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>